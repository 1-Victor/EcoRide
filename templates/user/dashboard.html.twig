{% extends 'base.html.twig' %}

{% block title %}Profil utilisateur{% endblock %}

{% block body %}
{% include 'components/menu.html.twig' %}

<div class="container py-5">
    <div class="row mb-4">
        <div class="col-md-2">
            {% if user.imageName %}
                <img src="{{ asset('uploads/users/image_profile/' ~ user.imageName) }}" alt="Photo de {{ user.username }}" class="img-thumbnail rounded-circle" style="width: 100px; height: 100px; object-fit: cover;">
            {% else %}
                <div class="bg-secondary text-white text-center rounded-circle" style="width: 100px; height: 100px; line-height: 100px;">
                    <img src="{{ asset('images/image_default.jpg') }}" alt="Photo de base" class="img-thumbnail rounded-circle" style="width: 100px; height: 100px; object-fit: cover;">
                </div>
            {% endif %}
        </div>
        <div class="col-md-10">
            <h4 class="p-3">{{ user.firstname }} {{ user.lastname }}</h4>
            <p>🆔 Pseudo : {{ user.username }}</p>
            <p>📞 Téléphone : {{ user.phone }}</p>
            <p>⭐ Note moyenne : {{ user.getAverageRating() }}/5</p>
            {% if app.user and app.user.id == user.id %}
                <p>💰 Crédits : {{ user.getcredit() }}</p>
            {% endif %}

            <h5>Rôles :</h5>
            <ul>
                {% for role in user.roles %}
                    <li>
                        {% if role == 'ROLE_USER' %}👤 Utilisateur
                        {% elseif role == 'ROLE_CHAUFFEUR' %}🚗 Chauffeur
                        {% elseif role == 'ROLE_PASSAGER' %}🧍‍♂️ Passager
                        {% elseif role == 'ROLE_ADMIN' %}🛡️ Administrateur
                        {% elseif role == 'ROLE_EMPLOYEE' %}🏢 Employé
                        {% else %}{{ role }}
                        {% endif %}
                    </li>
                {% endfor %}
            </ul>

            {% if app.user and app.user.id == user.id %}
                <a href="{{ path('app_user_roles') }}" class="btn btn-outline-secondary btn-sm">🎚 Modifier mes rôles</a>
                <a class="btn btn-outline-secondary btn-sm" href="{{ path('app_driver_dashboard') }}">🚘 Espace Chauffeur</a>
            {% endif %}
        </div>
    </div>

    <hr>

    <h3>🚗 Trajets proposés</h3>
    {% if user.carSharings is empty %}
        <div class="alert alert-info">Aucun trajet proposé.</div>
    {% else %}
        <ul class="list-group mb-4">
            {% for trajet in user.carSharings %}
                <li class="list-group-item">
                    {{ trajet.startAddress }} → {{ trajet.endAddress }} <br>
                    📅 {{ trajet.dateStart|date('d/m/Y H:i') }} — 💶 {{ trajet.price }} €
                    <a href="{{ path('app_trajet_show', { id: trajet.id }) }}" class="btn btn-sm btn-outline-primary float-end">Voir</a>
                </li>
            {% endfor %}
        </ul>
    {% endif %}

    <h3>🧍‍♂️ Trajets réservés</h3>
    {% if user.carSharingsParticipated is empty %}
        <div class="alert alert-info">Aucun covoiturage réservé.</div>
    {% else %}
        <ul class="list-group mb-4">
            {% for trajet in user.carSharingsParticipated %}
                <li class="list-group-item">
                    {{ trajet.startAddress }} → {{ trajet.endAddress }} <br>
                    📅 {{ trajet.dateStart|date('d/m/Y H:i') }} — 💶 {{ trajet.price }} €
                    <a href="{{ path('app_trajet_show', { id: trajet.id }) }}" class="btn btn-sm btn-outline-primary float-end">Voir</a>
                    {% if app.user and app.user.id == user.id %}
                        <a href="{{ path('carsharing_cancel', { id: trajet.id }) }}" class="btn btn-sm btn-outline-danger float-end me-2">❌ Annuler</a>
                    {% endif %}
                </li>
            {% endfor %}
        </ul>
    {% endif %}

    <h3>🚘 Véhicules</h3>
    {% if app.user and app.user.id == user.id %}
        <a href="{{ path('app_vehicle_new') }}" class="btn btn-outline-success btn-sm mb-2"><i class="bi bi-plus-lg p-1"></i> Ajouter un véhicule</a>
    {% endif %}

    {% if vehicles is empty %}
        <p>Aucun véhicule enregistré.</p>
    {% else %}
        <ul class="list-group mb-4">
            {% for v in vehicles %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        {{ v.brand }} {{ v.model }} - {{ v.color }}<br>
                        {{ v.seats }} places – {{ v.energy.name }} – {{ v.energy.autonomyKm }} km – {{ v.energy.co2Emission }} g/km
                    </div>
                    {% if app.user and app.user.id == user.id %}
                        <form method="post" action="{{ path('app_vehicle_delete', { id: v.id }) }}" onsubmit="return confirm('Supprimer ce véhicule ?');">
                            <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ v.id) }}">
                            <button class="btn btn-sm">🗑️</button>
                        </form>
                    {% endif %}
                </li>
            {% endfor %}
        </ul>
    {% endif %}

    <h3>🛠 Préférences</h3>
    {% if app.user and app.user.id == user.id %}
        <a href="{{ path('app_user_preference_add') }}" class="btn btn-outline-success btn-sm mb-2"><i class="bi bi-plus-lg p-1"></i> Ajouter une préférence</a>
    {% endif %}

    {% if preferences is empty %}
        <p>Aucune préférence définie.</p>
    {% else %}
        <ul class="list-group">
            {% for pref in preferences %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        {{ pref.preference.name }} : {{ pref.value }}
                    </div>
                    {% if app.user and app.user.id == user.id %}
                        <form method="post" action="{{ path('app_user_preference_delete', { id: pref.id }) }}" onsubmit="return confirm('Supprimer cette préférence ?');">
                            <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ pref.id) }}">
                            <button class="btn btn-sm">🗑️</button>
                        </form>
                    {% endif %}
                </li>
            {% endfor %}
        </ul>
    {% endif %}

    <p class="text-muted mt-4"><em>{% if app.user and app.user.id == user.id %}Voici votre espace personnel.{% else %}Ceci est une version publique du profil utilisateur.{% endif %}</em></p>
</div>
{% endblock %}
