{% extends 'base.html.twig' %}

{% block title %}Profil utilisateur{% endblock %}

{% block body %}
{% include 'components/menu.html.twig' %}

<div class="container py-5">

    {# ---------- INFOS UTILISATEUR ---------- #}
    <div class="row mb-4">
        <div class="col-md-2">
            {% if user.imageName %}
                <img src="{{ asset('uploads/users/image_profile/' ~ user.imageName) }}" alt="Photo de {{ user.username }}" class="img-thumbnail rounded-circle" style="width: 100px; height: 100px; object-fit: cover;">
            {% else %}
                <img src="{{ asset('images/image_default.jpg') }}" alt="Photo de base" class="img-thumbnail rounded-circle" style="width: 100px; height: 100px; object-fit: cover;">
            {% endif %}
        </div>

        <div class="col-md-10">

            {% if app.user and app.user.id == user.id %}
                <button class="btn btn-sm" data-bs-toggle="modal" data-bs-target="#settingsModal">
                    <i class="bi bi-gear"></i> ParamÃ¨tres
                </button>

            {% endif %}

            <h4 class="p-3">{{ user.firstname }} {{ user.lastname }}</h4>
            <p>ğŸ†” Pseudo : {{ user.username }}</p>
            <p>ğŸ“ TÃ©lÃ©phone : {{ user.phone }}</p>
            <p>â­ Note moyenne : {{ user.getAverageRating() }}/5</p>
            {% if app.user and app.user.id == user.id %}
                <p>ğŸ’° CrÃ©dits : {{ user.getCredit() }}</p>
            {% endif %}

            <h5>RÃ´les :</h5>
            <ul>
                {% for role in user.roles %}
                    <li>
                        {% if role == 'ROLE_USER' %}ğŸ‘¤ Utilisateur
                        {% elseif role == 'ROLE_CHAUFFEUR' %}ğŸš— Chauffeur
                        {% elseif role == 'ROLE_PASSAGER' %}ğŸ§â€â™‚ï¸ Passager
                        {% elseif role == 'ROLE_ADMIN' %}ğŸ›¡ï¸ Admin
                        {% elseif role == 'ROLE_EMPLOYEE' %}ğŸ¢ EmployÃ©
                        {% else %}{{ role }}
                        {% endif %}
                    </li>
                {% endfor %}
            </ul>
        </div>
    </div>

    <hr>

    {# ---------- TRAJETS PROPOSÃ‰S ---------- #}
    <h3>ğŸš— Trajets proposÃ©s</h3>

    {% set proposesAvenir = user.carSharings|filter(t => t.status.status == 'En attente') %}
    {% set proposesCours = user.carSharings|filter(t => t.status.status == 'En cours') %}
    {% set proposesTermines = user.carSharings|filter(t => t.status.status == 'TerminÃ©') %}

    <h5>â³ Ã€ venir</h5>
    {% if proposesAvenir is empty %}
        <div class="alert alert-info">Aucun trajet Ã  venir.</div>
    {% else %}
        <ul class="list-group mb-3">
            {% for trajet in proposesAvenir %}
                <li class="list-group-item">
                    {{ trajet.startAddress }} â†’ {{ trajet.endAddress }}<br>
                    ğŸ“… {{ trajet.dateStart|date('d/m/Y H:i') }} â€“ ğŸ’¶ {{ trajet.price }} â‚¬
                    <a href="{{ path('carsharing_start', { id: trajet.id }) }}" class="btn btn-sm btn-success float-end ms-2">â–¶ï¸ DÃ©marrer</a>
                    <a href="{{ path('app_trajet_show', { id: trajet.id }) }}" class="btn btn-sm btn-outline-primary float-end">Voir</a>
                </li>
            {% endfor %}
        </ul>
    {% endif %}

    <h5>ğŸš˜ En cours</h5>
    {% if proposesCours is empty %}
        <div class="alert alert-warning">Aucun trajet en cours.</div>
    {% else %}
        <ul class="list-group mb-3">
            {% for trajet in proposesCours %}
                <li class="list-group-item">
                    {{ trajet.startAddress }} â†’ {{ trajet.endAddress }}<br>
                    ğŸ“… {{ trajet.dateStart|date('d/m/Y H:i') }} â€“ ğŸ’¶ {{ trajet.price }} â‚¬
                    <a href="{{ path('carsharing_finish', { id: trajet.id }) }}" class="btn btn-sm btn-secondary float-end ms-2">âœ… ArrivÃ©e</a>
                    <a href="{{ path('app_trajet_show', { id: trajet.id }) }}" class="btn btn-sm btn-outline-primary float-end">Voir</a>
                </li>
            {% endfor %}
        </ul>
    {% endif %}

    <h5>âœ… TerminÃ©s</h5>
    {% if proposesTermines is empty %}
        <div class="alert alert-light">Aucun trajet terminÃ©.</div>
    {% else %}
        <ul class="list-group mb-4">
            {% for trajet in proposesTermines %}
                <li class="list-group-item">
                    {{ trajet.startAddress }} â†’ {{ trajet.endAddress }}<br>
                    ğŸ“… {{ trajet.dateStart|date('d/m/Y H:i') }} â€“ ğŸ’¶ {{ trajet.price }} â‚¬
                    <a href="{{ path('app_trajet_show', { id: trajet.id }) }}" class="btn btn-sm btn-outline-primary float-end">Voir</a>
                </li>
            {% endfor %}
        </ul>
    {% endif %}

    {# ---------- TRAJETS RÃ‰SERVÃ‰S (PASSAGER) ---------- #}
    <h3>ğŸ§â€â™‚ï¸ Trajets rÃ©servÃ©s</h3>
    {% if user.carSharingsParticipated is empty %}
        <div class="alert alert-info">Aucun covoiturage rÃ©servÃ©.</div>
    {% else %}
        <ul class="list-group mb-4">
            {% for trajet in user.carSharingsParticipated %}
                <li class="list-group-item">
                    {{ trajet.startAddress }} â†’ {{ trajet.endAddress }}<br>
                    ğŸ“… {{ trajet.dateStart|date('d/m/Y H:i') }} â€“ ğŸ’¶ {{ trajet.price }} â‚¬
                    <a href="{{ path('app_trajet_show', { id: trajet.id }) }}" class="btn btn-sm btn-outline-primary float-end">Voir</a>

                    {% if app.user and app.user.id == user.id %}
                        {% if trajet.status.status == 'TerminÃ©' and not trajet.hasReviewFrom(app.user) %}
                            <a href="{{ path('review_add', { id: trajet.id }) }}" class="btn btn-sm btn-success float-end me-2">âœï¸ Laisser un avis</a>
                        {% elseif trajet.status.status == 'En attente' %}
                            <a href="{{ path('carsharing_cancel', { id: trajet.id }) }}" class="btn btn-sm btn-outline-danger float-end me-2">âŒ Annuler</a>
                        {% endif %}
                    {% endif %}
                </li>
            {% endfor %}
        </ul>
    {% endif %}

    {# ---------- VÃ‰HICULES ---------- #}
    <h3>ğŸš˜ VÃ©hicules</h3>
    {% if app.user and app.user.id == user.id %}
        <a href="{{ path('app_vehicle_new') }}" class="btn btn-outline-success btn-sm mb-2">
            <i class="bi bi-plus-lg p-1"></i> Ajouter un vÃ©hicule
        </a>
    {% endif %}
    {% if vehicles is empty %}
        <p>Aucun vÃ©hicule enregistrÃ©.</p>
    {% else %}
        <ul class="list-group mb-4">
            {% for v in vehicles %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        {{ v.brand }} {{ v.model }} - {{ v.color }}<br>
                        {{ v.seats }} places â€“ {{ v.energy.name }} â€“ {{ v.energy.autonomyKm }} km â€“ {{ v.energy.co2Emission }} g/km
                    </div>
                    {% if app.user and app.user.id == user.id %}
                        <form method="post" action="{{ path('app_vehicle_delete', { id: v.id }) }}" onsubmit="return confirm('Supprimer ce vÃ©hicule ?');">
                            <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ v.id) }}">
                            <button class="btn btn-sm">ğŸ—‘ï¸</button>
                        </form>
                    {% endif %}
                </li>
            {% endfor %}
        </ul>
    {% endif %}

    {# ---------- PRÃ‰FÃ‰RENCES ---------- #}
    <h3>ğŸ›  PrÃ©fÃ©rences</h3>
    {% if app.user and app.user.id == user.id %}
        <a href="{{ path('app_user_preference_add') }}" class="btn btn-outline-success btn-sm mb-2">
            <i class="bi bi-plus-lg p-1"></i> Ajouter une prÃ©fÃ©rence
        </a>
    {% endif %}
    {% if preferences is empty %}
        <p>Aucune prÃ©fÃ©rence dÃ©finie.</p>
    {% else %}
        <ul class="list-group">
            {% for pref in preferences %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div>{{ pref.preference.name }} : {{ pref.value }}</div>
                    {% if app.user and app.user.id == user.id %}
                        <form method="post" action="{{ path('app_user_preference_delete', { id: pref.id }) }}" onsubmit="return confirm('Supprimer cette prÃ©fÃ©rence ?');">
                            <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ pref.id) }}">
                            <button class="btn btn-sm">ğŸ—‘ï¸</button>
                        </form>
                    {% endif %}
                </li>
            {% endfor %}
        </ul>
    {% endif %}

    {% for carSharing in user.carSharings %}
        <h6>ğŸš— Trajet : {{ carSharing.startAddress }} â†’ {{ carSharing.endAddress }}</h6>
        <ul>
            {% for participant in carSharing.participants %}
                <li>
                    {{ participant.username }}
                    {% set confirmed = false %}
                    {% for confirmation in carSharing.passengerConfirmations %}
                        {% if confirmation.passenger.id == participant.id and confirmation.confirmed %}
                            {% set confirmed = true %}
                        {% endif %}
                    {% endfor %}
                    : {{ confirmed ? "âœ… confirmÃ©" : "âŒ en attente" }}
                </li>
            {% endfor %}
        </ul>
    {% endfor %}

    <p class="text-muted mt-4"><em>{% if app.user and app.user.id == user.id %}Voici votre espace personnel.{% else %}Ceci est une version publique du profil utilisateur.{% endif %}</em></p>

</div>

<div class="modal fade" id="settingsModal" tabindex="-1" aria-labelledby="settingsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content shadow">
            <div class="modal-header">
                <h5 class="modal-title" id="settingsModalLabel">
                <i class="bi bi-gear-fill me-2"></i> ParamÃ¨tres de votre compte
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
            </div>

            <div class="modal-body">

                <div class="row">
                    <div class="col-md-4 text-center">
                        {% if app.user.imageName %}
                            <img src="{{ asset('uploads/users/image_profile/' ~ app.user.imageName) }}" alt="Photo de {{ app.user.username }}" class="rounded-circle mb-3" style="width: 120px; height: 120px; object-fit: cover;">
                        {% else %}
                            <img src="{{ asset('images/image_default.jpg') }}" alt="Photo par dÃ©faut" class="rounded-circle mb-3" style="width: 120px; height: 120px; object-fit: cover;">
                        {% endif %}
                            <p><strong>{{ app.user.firstname }} {{ app.user.lastname }}</strong></p>
                            <p>Pseudo : {{ app.user.username }}</p>
                            <p>CrÃ©dits : ğŸ’° {{ app.user.getCredit() }}</p>
                    </div>

                    <div class="col-md-8">
                        <div class="list-group">

                        <a href="{{ path('app_user_roles') }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-sliders2 me-2"></i>Modifier mes rÃ´les</span>
                            <i class="bi bi-chevron-right"></i>
                        </a>

                        <a href="{{ path('app_driver_dashboard') }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-car-front-fill me-2 text-success"></i>AccÃ©der Ã  lâ€™espace chauffeur</span>
                            <i class="bi bi-chevron-right"></i>
                        </a>

                        <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-envelope-paper-fill me-2 text-primary"></i>Contacter lâ€™Ã©quipe</span>
                            <i class="bi bi-chevron-right"></i>
                        </a>

                        <a href="{{ path('app_logout') }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center text-danger">
                            <span><i class="bi bi-box-arrow-right me-2"></i>Se dÃ©connecter</span>
                            <i class="bi bi-chevron-right"></i>
                        </a>

                    </div>
                </div>
            </div>

        </div>
    </div>
</div>
</div>
{% endblock %}
