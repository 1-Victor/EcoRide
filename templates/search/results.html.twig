{% extends 'base.html.twig' %}

{% block title %}R√©sultats de recherche{% endblock %}

{% block body %}
{% include 'components/menu.html.twig' %}
<div class="container py-4">
    <h2>R√©sultats pour le trajet {{ from }} ‚Üí {{ to }} le {{ date|date('d/m/Y') }}</h2>

    {% if eco or max_price or max_duration or min_rating %}
        <div class="alert alert-info mt-3">
            <strong>Filtres actifs :</strong>
            <ul class="mb-0">
                {% if eco %}
                    <li>üü¢ Voyages √©cologiques uniquement</li>
                {% endif %}
                {% if max_price %}
                    <li>üí∞ Prix maximum : {{ max_price }} ‚Ç¨</li>
                {% endif %}
                {% if max_duration %}
                    <li>‚è± Dur√©e maximale : {{ max_duration }} minutes</li>
                {% endif %}
                {% if min_rating %}
                    <li>‚≠ê Note minimale du conducteur : {{ min_rating }}/5</li>
                {% endif %}
            </ul>
        </div>
    {% endif %}

    {% if results is empty %}
        <p class="text-muted">Aucun covoiturage trouv√©.</p>

        {% if alternative %}
            <p>
                Prochain trajet propos√© :
                <strong>{{ alternative.dateStart|date('d/m/Y H:i') }}</strong><br>
                <a href="{{ path('app_trajet_show', { id: alternative.id }) }}" class="btn btn-outline-success mt-2">
                    Voir ce trajet
                </a>
            </p>
        {% endif %}
    {% else %}
        <div class="row">
            {% for item in results %}
                {% set duration = item.dateStart.diff(item.dateEnd) %}
                {% set duration_minutes = (duration.h * 60) + duration.i %}
                {% set notes = item.user.reviews|map(r => r.note)|filter(n => n is not null) %}
                {% set avg = notes|length > 0 ? (notes|reduce((carry, n) => carry + n) / notes|length)|number_format(1) : 'Aucune note' %}

                <div class="col-md-6 mb-4">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <div class="d-flex align-items-center mb-2">
                                {% if item.user.imageName %}
                                    <img src="{{ asset('uploads/users/image_profile/' ~ item.user.imageName) }}"
                                        class="rounded-circle me-3"
                                        style="width: 50px; height: 50px; object-fit: cover;"
                                        alt="{{ item.user.username }}">
                                {% endif %}
                                <div>
                                    <strong>{{ item.user.username }}</strong><br>
                                    <small>Note : {{ avg }}/5 ‚≠ê</small>
                                </div>
                            </div>

                            <p class="card-text">
                                D√©part : {{ item.dateStart|date('d/m/Y H:i') }}<br>
                                Arriv√©e : {{ item.dateEnd|date('d/m/Y H:i') }}<br>
                                üïì Dur√©e estim√©e : {{ duration_minutes }} minutes<br>
                                üí∞ Prix : {{ item.price }} ‚Ç¨<br>
                                üë• Places dispo : {{ item.availablePlaces }} / {{ item.totalPlaces }}<br>
                                üå± √âcologique : {{ item.ecoFriendly ? 'Oui ‚úÖ' : 'Non ‚ùå' }}
                            </p>

                            <a href="{{ path('app_trajet_show', { id: item.id }) }}" class="btn btn-success">
                                Voir le d√©tail
                            </a>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <a href="{{ path('app_home') }}" class="btn btn-outline-secondary mt-4">‚Üê Retour √† l'accueil</a>
</div>
{% endblock %}
