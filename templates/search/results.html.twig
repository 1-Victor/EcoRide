{% extends 'base.html.twig' %}

{% block title %}RÃ©sultats de recherche{% endblock %}

{% block body %}
{% include 'components/menu.html.twig' %}

<div class="container py-5">
    <h2 class="mb-4 text-success">
        <i class="bi bi-search"></i> RÃ©sultats pour le trajet {{ from }} â†’ {{ to }} le {{ date|date('d/m/Y') }}
    </h2>

    {% if eco or max_price or max_duration or min_rating %}
        <div class="alert alert-info">
            <h5 class="mb-2"><i class="bi bi-funnel-fill"></i> Filtres actifs :</h5>
            <ul class="mb-0">
                {% if eco %}
                    <li>ğŸŒ¿ Voyages Ã©cologiques uniquement</li>
                {% endif %}
                {% if max_price %}
                    <li>ğŸ’° Prix maximum : <strong>{{ max_price }} â‚¬</strong></li>
                {% endif %}
                {% if max_duration %}
                    <li>â± DurÃ©e maximale : <strong>{{ max_duration }} minutes</strong></li>
                {% endif %}
                {% if min_rating %}
                    <li>â­ Note minimale du conducteur : <strong>{{ min_rating }}/5</strong></li>
                {% endif %}
            </ul>
        </div>
    {% endif %}

    {% if carSharings is not defined or carSharings is empty %}
        <div class="alert alert-warning">
            <i class="bi bi-exclamation-circle"></i> Aucun covoiturage trouvÃ© pour les critÃ¨res spÃ©cifiÃ©s.
        </div>

        {% if alternative %}
            <div class="alert alert-secondary">
                <strong>Prochain trajet suggÃ©rÃ© :</strong><br>
                ğŸ“… <strong>{{ alternative.dateStart|date('d/m/Y H:i') }}</strong><br>
                <a href="{{ path('app_trajet_show', { id: alternative.id }) }}" class="btn btn-outline-success btn-sm mt-2">
                    Voir ce trajet
                </a>
            </div>
        {% endif %}
    {% else %}
        <div class="row">
            {% for item in carSharings %}
                {% set duration = item.dateStart.diff(item.dateEnd) %}
                {% set duration_minutes = (duration.days * 1440) + (duration.h * 60) + duration.i %}
                {% set notes = item.user.reviewsReceived|map(r => r.rating)|filter(n => n is not null) %}
                {% set avg = notes|length > 0 ? (notes|reduce((carry, n) => carry + n) / notes|length)|number_format(1) : 'Aucune note' %}

                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="card h-100 shadow-sm">
                        <div class="card-body">
                            <div class="d-flex align-items-center mb-3">
                                {% if item.user.imageName %}
                                    <img src="{{ asset('uploads/users/image_profile/' ~ item.user.imageName) }}"
                                        class="rounded-circle me-3"
                                        style="width: 50px; height: 50px; object-fit: cover;"
                                        alt="Photo de {{ item.user.username }}">
                                {% endif %}
                                <div>
                                    <strong>{{ item.user.username }}</strong><br>
                                    <small>â­ {{ avg }}/5</small>
                                </div>
                            </div>

                            <ul class="list-unstyled small">
                                <li>ğŸ“ <strong>DÃ©part :</strong> {{ item.dateStart|date('d/m/Y H:i') }}</li>
                                <li>ğŸ <strong>ArrivÃ©e :</strong> {{ item.dateEnd|date('d/m/Y H:i') }}</li>
                                <li>ğŸ•“ <strong>DurÃ©e :</strong> {{ duration_minutes }} min</li>
                                <li>ğŸ’° <strong>Prix :</strong> {{ item.price }} â‚¬</li>
                                <li>ğŸ‘¥ <strong>Places dispo :</strong> {{ item.availablePlaces }}/{{ item.totalPlaces }}</li>
                                <li>
                                    ğŸŒ± <strong>Ã‰cologique :</strong>
                                    {{ item.ecoFriendly ? 'Oui âœ…' : 'Non âŒ' }}
                                </li>
                            </ul>

                            <div class="text-end">
                                <a href="{{ path('app_trajet_show', { id: item.id }) }}" class="btn btn-success btn-sm">
                                    Voir le dÃ©tail
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% endif %}
</div>
{% endblock %}
